<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listening Practice - IELTS Notes</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .practice-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .practice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-light);
        }

        .practice-header h1 {
            font-size: 1.75rem;
            color: var(--text-dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .practice-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-medium);
            font-size: 0.95rem;
        }

        .practice-card {
            background: var(--background-white);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .audio-player-section {
            margin-bottom: 2rem;
        }

        .audio-player-section audio {
            width: 100%;
            margin-top: 0.5rem;
        }

        .sentence-section {
            margin-bottom: 2rem;
        }

        .sentence-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-medium);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .answer-input {
            width: 100%;
            padding: 1rem;
            font-size: 1rem;
            line-height: 1.6;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            background: var(--background-white);
            color: var(--text-dark);
            transition: all 0.3s ease;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
        }

        .answer-input:focus {
            outline: none;
            border-color: var(--primary-purple);
            box-shadow: 0 0 0 3px var(--primary-purple-lighter);
        }

        .answer-input.checked {
            pointer-events: none;
        }

        .correct-answer {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--background-light);
            border-radius: 8px;
            border-left: 4px solid var(--btn-green);
            display: none;
        }

        .correct-answer.show {
            display: block;
        }

        .correct-answer-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--btn-green);
            margin-bottom: 0.5rem;
        }

        .correct-answer-text {
            color: var(--text-dark);
            line-height: 1.6;
        }

        .result-display {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            display: none;
        }

        .result-display.show {
            display: block;
        }

        .result-text {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .result-correct {
            background: rgba(16, 185, 129, 0.1);
            color: var(--btn-green);
        }

        .result-wrong {
            background: rgba(239, 68, 68, 0.1);
            color: var(--btn-red);
        }

        .result-missing {
            background: rgba(245, 158, 11, 0.1);
            color: var(--btn-orange);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn-check {
            background: var(--btn-purple);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .btn-check:hover:not(:disabled) {
            background: var(--btn-purple-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-check:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-next {
            background: var(--btn-blue);
            color: white;
            border: none;
            padding: 0.875rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            display: none;
        }

        .btn-next.show {
            display: flex;
        }

        .btn-next:hover {
            background: var(--btn-blue-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn-back {
            background: var(--background-white);
            color: var(--text-dark);
            border: 1px solid var(--border-light);
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .btn-back:hover {
            background: var(--background-light);
            border-color: var(--primary-purple);
            color: var(--primary-purple);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-back:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn-back i {
            transition: transform 0.2s ease;
        }

        .btn-back:hover i {
            transform: translateX(-3px);
        }

        .highlighted-text {
            padding: 0.1rem 0.2rem;
            border-radius: 3px;
        }

        .highlight-correct {
            background: rgba(16, 185, 129, 0.2);
            color: var(--btn-green);
            font-weight: 600;
        }

        .highlight-wrong {
            background: rgba(239, 68, 68, 0.2);
            color: var(--btn-red);
            text-decoration: line-through;
        }

        .highlight-missing {
            background: rgba(245, 158, 11, 0.2);
            color: var(--btn-orange);
            font-weight: 600;
        }

        .no-sentences {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-muted);
        }

        .no-sentences i {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }

        .no-sentences h2 {
            font-size: 1.5rem;
            color: var(--text-dark);
            margin: 1rem 0 0.5rem 0;
        }

        .no-sentences p {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 0;
        }

        .note-content-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid var(--border-light);
        }

        .note-content-display {
            margin-top: 0.75rem;
        }

        .note-edit-form {
            margin-top: 1rem;
            padding: 1.5rem;
            background: var(--background-light);
            border-radius: 8px;
            border: 1px solid var(--border-light);
        }

        .btn-edit-note {
            transition: all 0.2s ease;
        }

        .btn-edit-note:hover {
            background: rgba(139, 92, 246, 0.1) !important;
        }

        .btn-save-note {
            background: var(--btn-purple);
            color: white;
            border: none;
            padding: 0.75rem 1.75rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .btn-save-note:hover {
            background: var(--btn-purple-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-save-note:active {
            transform: translateY(0);
        }

        .btn-cancel-edit {
            background: var(--background-white);
            color: var(--text-medium);
            border: 1px solid var(--border-light);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-cancel-edit:hover {
            background: var(--background-light);
            border-color: var(--border-medium);
            color: var(--text-dark);
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">IELTS Notes</a>
            <ul class="nav-menu">
                <li><a href="../index.html">Home</a></li>
                <li><a href="listening.html">Listening</a></li>
                <li><a href="reading.html">Reading</a></li>
                <li><a href="speaking.html">Speaking</a></li>
                <li><a href="writing.html">Writing</a></li>
                <li><a href="vocabulary.html">Vocabulary</a></li>
            </ul>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="practice-container">
            <div class="practice-header">
                <h1><i class="fas fa-headphones"></i> Listening Practice</h1>
                <div class="practice-progress">
                    <span id="currentIndex">1</span> / <span id="totalCount">0</span>
                </div>
            </div>

            <div id="practiceContent">
                <!-- 内容将动态加载 -->
            </div>
        </div>
    </main>

    <script>
        // 获取句子数据
        const sentences = JSON.parse(sessionStorage.getItem('listeningSentences') || '[]');
        let currentIndex = 0;
        let isChecked = false;
        let practiceResults = []; // 存储练习结果

        // 初始化
        function init() {
            if (sentences.length === 0) {
                showNoSentences();
                return;
            }

            document.getElementById('totalCount').textContent = sentences.length;
            loadSentence(currentIndex);
        }

        // 显示没有句子的提示
        function showNoSentences() {
            const content = document.getElementById('practiceContent');
            content.innerHTML = `
                <div class="practice-card no-sentences">
                    <i class="fas fa-inbox"></i>
                    <h2>No sentences available</h2>
                    <p>Please go back to the Listening page and start a listening practice session.</p>
                </div>
            `;
        }

        // 加载句子
        function loadSentence(index) {
            if (index < 0 || index >= sentences.length) {
                return;
            }

            const sentence = sentences[index];
            isChecked = false;

            const content = document.getElementById('practiceContent');
            content.innerHTML = `
                <div class="practice-card">
                    <div class="audio-player-section">
                        <div class="sentence-label">
                            <i class="fas fa-volume-up"></i> Audio
                        </div>
                        <audio controls>
                            <source src="${sentence.audioData}" type="audio/mpeg">
                            <source src="${sentence.audioData}" type="audio/wav">
                            <source src="${sentence.audioData}" type="audio/ogg">
                            Your browser does not support the audio element.
                        </audio>
                    </div>

                    <div class="sentence-section">
                        <div class="sentence-label">
                            <i class="fas fa-pencil-alt"></i> Type what you hear
                        </div>
                        <textarea 
                            id="userAnswer" 
                            class="answer-input" 
                            placeholder="Listen to the audio and type the sentence here..."
                        ></textarea>
                    </div>

                    <div class="correct-answer" id="correctAnswer">
                        <div class="correct-answer-label">
                            <i class="fas fa-check-circle"></i> Correct Answer
                        </div>
                        <div class="correct-answer-text" id="correctAnswerText"></div>
                    </div>

                    <div class="result-display" id="resultDisplay"></div>

                    <div class="note-content-section" id="noteContentSection" style="display: none;">
                        <div class="sentence-label" style="margin-top: 1.5rem;">
                            <i class="fas fa-sticky-note"></i> Note Content
                            <button class="btn-edit-note" id="editNoteBtn" style="margin-left: auto; background: transparent; border: none; color: var(--primary-purple); cursor: pointer; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                        <div class="note-content-display" id="noteContentDisplay"></div>
                        <div class="note-edit-form" id="noteEditForm" style="display: none;">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">Content</label>
                                <div class="editor-toolbar" style="margin-bottom: 0;">
                                    <button type="button" class="editor-btn" data-command="bold" title="Bold">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button type="button" class="editor-btn" data-command="italic" title="Italic">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button type="button" class="editor-btn" data-command="underline" title="Underline">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                </div>
                                <div id="noteContentEditor" contenteditable="true" style="min-height: 100px; padding: 0.8rem; border: 1px solid var(--border-light); border-radius: 0 0 8px 8px; background: white; outline: none;"></div>
                            </div>
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: var(--text-dark);">Key Points</label>
                                <div id="keyPointsContainer"></div>
                                <button type="button" id="addKeyPointBtn" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: rgba(139, 92, 246, 0.1); color: var(--primary-purple); border: none; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">
                                    <i class="fas fa-plus"></i> Add Key Point
                                </button>
                            </div>
                            <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem; justify-content: flex-end;">
                                <button class="btn-cancel-edit" id="cancelEditBtn">
                                    Cancel
                                </button>
                                <button class="btn-save-note" id="saveNoteBtn">
                                    <i class="fas fa-save"></i> Save Note
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="action-buttons">
                        <button class="btn-check" id="checkBtn">
                            <i class="fas fa-check"></i> Check Answer
                        </button>
                        <button class="btn-next" id="nextBtn">
                            <i class="fas fa-arrow-right"></i> Next
                        </button>
                    </div>
                </div>
            `;

            // 绑定事件
            document.getElementById('checkBtn').addEventListener('click', checkAnswer);
            document.getElementById('nextBtn').addEventListener('click', nextSentence);

            // 更新进度
            document.getElementById('currentIndex').textContent = index + 1;

            // 保存当前句子的 noteId
            window.currentNoteId = sentence.noteId;
        }

        // 检查答案
        function checkAnswer() {
            if (isChecked) return;

            const userAnswer = document.getElementById('userAnswer').value.trim().toLowerCase();
            const correctAnswer = sentences[currentIndex].sentence.trim().toLowerCase();

            if (!userAnswer) {
                alert('Please enter your answer first.');
                return;
            }

            isChecked = true;

            // 禁用输入框
            document.getElementById('userAnswer').classList.add('checked');

            // 显示正确答案
            const correctAnswerDiv = document.getElementById('correctAnswer');
            const correctAnswerText = document.getElementById('correctAnswerText');
            correctAnswerDiv.classList.add('show');
            correctAnswerText.innerHTML = highlightDifferences(userAnswer, correctAnswer);

            // 显示结果统计
            const result = compareAnswers(userAnswer, correctAnswer);
            showResult(result);

            // 保存结果
            const sentence = sentences[currentIndex];
            practiceResults.push({
                sentence: sentence.sentence,
                userAnswer: document.getElementById('userAnswer').value.trim(),
                noteId: sentence.noteId,
                correct: result.correct,
                wrong: result.wrong,
                missing: result.missing,
                total: result.total
            });

            // 显示/隐藏按钮
            document.getElementById('checkBtn').disabled = true;
            document.getElementById('nextBtn').classList.add('show');

            // 加载并显示笔记内容
            loadNoteContent();
        }

        // 加载笔记内容
        function loadNoteContent() {
            if (!window.currentNoteId) return;

            const notes = JSON.parse(localStorage.getItem('listeningNotes') || '[]');
            const note = notes.find(n => n.id === window.currentNoteId);

            if (!note) {
                console.warn('Note not found:', window.currentNoteId);
                return;
            }

            const noteContentSection = document.getElementById('noteContentSection');
            const noteContentDisplay = document.getElementById('noteContentDisplay');

            // 构建笔记内容显示
            let contentHTML = '';

            if (note.question) {
                contentHTML += `
                    <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-light);">
                        <div style="font-weight: 600; color: var(--text-medium); margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <i class="fas fa-question-circle"></i> Question
                        </div>
                        <div style="color: var(--text-dark);">${note.question}</div>
                    </div>
                `;
            }

            if (note.imageData) {
                contentHTML += `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: 600; color: var(--text-medium); margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <i class="fas fa-image"></i> Map Image
                        </div>
                        <img src="${note.imageData}" alt="Map" style="max-width: 100%; border-radius: 8px; margin-top: 0.5rem;">
                    </div>
                `;
            }

            if (note.content) {
                contentHTML += `
                    <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-light);">
                        <div style="font-weight: 600; color: var(--text-medium); margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <i class="fas fa-align-left"></i> Content
                        </div>
                        <div style="color: var(--text-dark); line-height: 1.6;">${note.content}</div>
                    </div>
                `;
            }

            if (note.keyPoints && note.keyPoints.length > 0) {
                // 从 HTML 中提取纯文本
                const getPlainText = (html) => {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = html;
                    return tempDiv.textContent || tempDiv.innerText || '';
                };
                
                // 处理所有 key points，提取纯文本
                const plainTextPoints = note.keyPoints.map(point => getPlainText(point));
                
                contentHTML += `
                    <div style="margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-light);">
                        <div style="font-weight: 600; color: var(--text-medium); margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <i class="fas fa-key"></i> Key Points
                        </div>
                        <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-dark); line-height: 1.6;">
                            ${plainTextPoints.map(point => `<li>${point}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (note.errorReason && note.errorReason.trim()) {
                contentHTML += `
                    <div style="margin-bottom: 1rem;">
                        <div style="font-weight: 600; color: var(--text-medium); margin-bottom: 0.5rem; font-size: 0.85rem;">
                            <i class="fas fa-exclamation-triangle"></i> Error Reason
                        </div>
                        <div style="color: var(--text-dark);">${note.errorReason}</div>
                    </div>
                `;
            }

            noteContentDisplay.innerHTML = contentHTML || '<p style="color: var(--text-muted);">No additional content</p>';
            noteContentSection.style.display = 'block';

            // 绑定编辑按钮事件
            const editBtn = document.getElementById('editNoteBtn');
            if (editBtn) {
                // 移除旧的事件监听器（如果存在）
                const newEditBtn = editBtn.cloneNode(true);
                editBtn.parentNode.replaceChild(newEditBtn, editBtn);
                newEditBtn.addEventListener('click', function() {
                    showEditForm(note);
                });
            }
        }

        // 显示编辑表单
        function showEditForm(note) {
            const noteContentDisplay = document.getElementById('noteContentDisplay');
            const noteEditForm = document.getElementById('noteEditForm');

            noteContentDisplay.style.display = 'none';
            noteEditForm.style.display = 'block';

            // 填充表单数据
            document.getElementById('noteContentEditor').innerHTML = note.content || '';

            // 填充关键点
            const keyPointsContainer = document.getElementById('keyPointsContainer');
            keyPointsContainer.innerHTML = '';
            
            // 从 HTML 中提取纯文本的辅助函数
            const getPlainText = (html) => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                return tempDiv.textContent || tempDiv.innerText || '';
            };
            
            if (note.keyPoints && note.keyPoints.length > 0) {
                note.keyPoints.forEach((point, index) => {
                    // 提取纯文本
                    const plainText = getPlainText(point);
                    // 转义 HTML 特殊字符（用于 input value）
                    const escapedPoint = plainText.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
                    const keyPointHTML = `
                        <div class="key-point-item" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: flex-start;">
                            <input type="text" class="key-point-input" value="${escapedPoint}" style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-light); border-radius: 6px; font-size: 0.9rem;">
                            <button type="button" class="remove-key-point" style="padding: 0.5rem; background: rgba(239, 68, 68, 0.1); color: var(--btn-red); border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    keyPointsContainer.insertAdjacentHTML('beforeend', keyPointHTML);
                });
            } else {
                // 添加一个空的
                addKeyPointInput();
            }

            // 绑定事件
            const addBtn = document.getElementById('addKeyPointBtn');
            if (addBtn) {
                // 移除旧的事件监听器
                const newAddBtn = addBtn.cloneNode(true);
                addBtn.parentNode.replaceChild(newAddBtn, addBtn);
                newAddBtn.addEventListener('click', addKeyPointInput);
            }

            document.querySelectorAll('.remove-key-point').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (keyPointsContainer.children.length > 1) {
                        this.closest('.key-point-item').remove();
                    }
                });
            });

            // 绑定编辑器工具栏
            document.querySelectorAll('.editor-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const command = this.getAttribute('data-command');
                    document.getElementById('noteContentEditor').focus();
                    document.execCommand(command, false, null);
                });
            });

            // 绑定保存和取消按钮
            const saveBtn = document.getElementById('saveNoteBtn');
            const cancelBtn = document.getElementById('cancelEditBtn');
            
            if (saveBtn) {
                // 移除旧的事件监听器
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                newSaveBtn.addEventListener('click', saveNote);
            }
            
            if (cancelBtn) {
                // 移除旧的事件监听器
                const newCancelBtn = cancelBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                newCancelBtn.addEventListener('click', cancelEdit);
            }
        }

        // 添加关键点输入框
        function addKeyPointInput() {
            const keyPointsContainer = document.getElementById('keyPointsContainer');
            const keyPointHTML = `
                <div class="key-point-item" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: flex-start;">
                    <input type="text" class="key-point-input" placeholder="Enter key point..." style="flex: 1; padding: 0.5rem; border: 1px solid var(--border-light); border-radius: 6px; font-size: 0.9rem;">
                    <button type="button" class="remove-key-point" style="padding: 0.5rem; background: rgba(239, 68, 68, 0.1); color: var(--btn-red); border: none; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            keyPointsContainer.insertAdjacentHTML('beforeend', keyPointHTML);

            // 绑定删除按钮
            const newItem = keyPointsContainer.lastElementChild;
            newItem.querySelector('.remove-key-point').addEventListener('click', function() {
                if (keyPointsContainer.children.length > 1) {
                    this.closest('.key-point-item').remove();
                }
            });
        }

        // 保存笔记
        function saveNote() {
            if (!window.currentNoteId) return;

            const notes = JSON.parse(localStorage.getItem('listeningNotes') || '[]');
            const noteIndex = notes.findIndex(n => n.id === window.currentNoteId);

            if (noteIndex === -1) {
                alert('Note not found!');
                return;
            }

            // 获取编辑后的内容
            const content = document.getElementById('noteContentEditor').innerHTML;
            
            // 获取关键点
            const keyPoints = [];
            document.querySelectorAll('.key-point-input').forEach(input => {
                const value = input.value.trim();
                if (value) {
                    keyPoints.push(value);
                }
            });

            // 更新笔记（保留原有的 errorReason，不修改）
            notes[noteIndex].content = content;
            notes[noteIndex].keyPoints = keyPoints;

            // 保存到 localStorage
            localStorage.setItem('listeningNotes', JSON.stringify(notes));

            // 更新显示的笔记内容
            window.currentNote = notes[noteIndex];
            cancelEdit();
            loadNoteContent();

            // 显示保存成功提示
            const saveBtn = document.getElementById('saveNoteBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-check"></i> Saved!';
            saveBtn.style.background = 'var(--btn-green)';
            setTimeout(() => {
                saveBtn.innerHTML = originalText;
                saveBtn.style.background = '';
            }, 2000);
        }

        // 取消编辑
        function cancelEdit() {
            const noteContentDisplay = document.getElementById('noteContentDisplay');
            const noteEditForm = document.getElementById('noteEditForm');

            noteContentDisplay.style.display = 'block';
            noteEditForm.style.display = 'none';
        }

        // 清理单词（移除标点，转为小写）
        function cleanWord(word) {
            return word.toLowerCase().replace(/[.,!?;:'"()\[\]{}]/g, '').trim();
        }

        // 对比答案并高亮显示
        function highlightDifferences(userAnswer, correctAnswer) {
            const userWords = userAnswer.split(/\s+/).filter(w => w.trim());
            const correctWords = correctAnswer.split(/\s+/).filter(w => w.trim());

            // 使用动态规划进行最佳对齐
            const alignment = findBestAlignment(userWords, correctWords);
            
            let result = '';
            
            alignment.forEach(item => {
                if (item.type === 'match') {
                    // 匹配成功
                    result += `<span class="highlighted-text highlight-correct">${correctWords[item.correctIndex]}</span> `;
                } else if (item.type === 'replace') {
                    // 替换（错误单词）
                    result += `<span class="highlighted-text highlight-wrong"><del>${userWords[item.userIndex]}</del></span> `;
                    result += `<span class="highlighted-text highlight-correct">${correctWords[item.correctIndex]}</span> `;
                } else if (item.type === 'delete') {
                    // 删除（用户答案多余的单词）
                    result += `<span class="highlighted-text highlight-wrong"><del>${userWords[item.userIndex]}</del></span> `;
                } else if (item.type === 'insert') {
                    // 插入（缺失的单词）
                    result += `<span class="highlighted-text highlight-missing">${correctWords[item.correctIndex]}</span> `;
                }
            });

            return result.trim();
        }

        // 找到最佳对齐（返回对齐信息）
        function findBestAlignment(userWords, correctWords) {
            const m = userWords.length;
            const n = correctWords.length;
            
            // 使用动态规划找到最佳对齐
            const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
            const path = Array(m + 1).fill(null).map(() => Array(n + 1).fill(null));
            
            // 初始化
            for (let i = 0; i <= m; i++) {
                for (let j = 0; j <= n; j++) {
                    if (i === 0 && j === 0) {
                        dp[i][j] = 0;
                        path[i][j] = 'start';
                    } else if (i === 0) {
                        dp[i][j] = 0;
                        path[i][j] = 'insert';
                    } else if (j === 0) {
                        dp[i][j] = 0;
                        path[i][j] = 'delete';
                    } else {
                        const userWordClean = cleanWord(userWords[i - 1]);
                        const correctWordClean = cleanWord(correctWords[j - 1]);
                        const match = userWordClean === correctWordClean ? 1 : 0;
                        
                        // 三种操作：匹配/替换、删除、插入
                        const matchScore = dp[i - 1][j - 1] + match;
                        const deleteScore = dp[i - 1][j];
                        const insertScore = dp[i][j - 1];
                        
                        if (matchScore >= deleteScore && matchScore >= insertScore) {
                            dp[i][j] = matchScore;
                            path[i][j] = match === 1 ? 'match' : 'replace';
                        } else if (deleteScore >= insertScore) {
                            dp[i][j] = deleteScore;
                            path[i][j] = 'delete';
                        } else {
                            dp[i][j] = insertScore;
                            path[i][j] = 'insert';
                        }
                    }
                }
            }
            
            // 回溯找到对齐路径
            const alignment = [];
            let i = m, j = n;
            
            while (i > 0 || j > 0) {
                if (i === 0) {
                    // 只能插入（missing word）
                    alignment.unshift({
                        type: 'insert',
                        correctIndex: j - 1
                    });
                    j--;
                } else if (j === 0) {
                    // 只能删除（extra word）
                    alignment.unshift({
                        type: 'delete',
                        userIndex: i - 1
                    });
                    i--;
                } else {
                    const action = path[i][j];
                    if (action === 'match') {
                        // 匹配成功
                        alignment.unshift({
                            type: 'match',
                            userIndex: i - 1,
                            correctIndex: j - 1
                        });
                        i--;
                        j--;
                    } else if (action === 'replace') {
                        // 替换（错误单词）
                        alignment.unshift({
                            type: 'replace',
                            userIndex: i - 1,
                            correctIndex: j - 1
                        });
                        i--;
                        j--;
                    } else if (action === 'delete') {
                        // 删除（用户答案多余的单词）
                        alignment.unshift({
                            type: 'delete',
                            userIndex: i - 1
                        });
                        i--;
                    } else if (action === 'insert') {
                        // 插入（缺失的单词）
                        alignment.unshift({
                            type: 'insert',
                            correctIndex: j - 1
                        });
                        j--;
                    }
                }
            }
            
            return alignment;
        }

        // 找到最佳匹配（用于统计，使用对齐结果）
        function findBestMatch(userWords, correctWords) {
            const alignment = findBestAlignment(userWords, correctWords);
            const matches = [];
            
            alignment.forEach(item => {
                if (item.type === 'match') {
                    matches.push({ userIndex: item.userIndex, correctIndex: item.correctIndex });
                }
            });
            
            return matches;
        }

        // 对比答案并返回统计结果
        function compareAnswers(userAnswer, correctAnswer) {
            const userWords = userAnswer.split(/\s+/).filter(w => w.trim());
            const correctWords = correctAnswer.split(/\s+/).filter(w => w.trim());

            // 使用相同的匹配算法
            const matches = findBestMatch(userWords, correctWords);
            
            const correct = matches.length;
            const missing = correctWords.length - correct;
            const wrong = userWords.length - correct;

            return { correct, wrong, missing, total: correctWords.length };
        }

        // 显示结果统计
        function showResult(result) {
            const resultDiv = document.getElementById('resultDisplay');
            const accuracy = result.total > 0 ? Math.round((result.correct / result.total) * 100) : 0;

            resultDiv.innerHTML = `
                <div class="result-text result-correct">
                    <i class="fas fa-check"></i> Correct: ${result.correct}
                </div>
                <div class="result-text result-wrong">
                    <i class="fas fa-times"></i> Wrong: ${result.wrong}
                </div>
                <div class="result-text result-missing">
                    <i class="fas fa-minus"></i> Missing: ${result.missing}
                </div>
                <div style="margin-top: 0.5rem; font-weight: 600; color: var(--text-dark);">
                    Accuracy: ${accuracy}%
                </div>
            `;
            resultDiv.classList.add('show');
        }

        // 下一句
        function nextSentence() {
            currentIndex++;
            if (currentIndex >= sentences.length) {
                // 完成所有练习，保存记录
                saveListeningRecord();
                
                document.getElementById('practiceContent').innerHTML = `
                <div class="practice-card no-sentences">
                    <i class="fas fa-check-circle" style="color: var(--btn-green); font-size: 4rem;"></i>
                    <h2 style="margin: 1rem 0 0.5rem 0; color: var(--text-dark);">Practice Complete!</h2>
                    <p style="margin-bottom: 2rem; color: var(--text-muted);">You have finished all ${sentences.length} sentences.</p>
                </div>
                `;
            } else {
                loadSentence(currentIndex);
            }
        }

        // 保存精听记录
        function saveListeningRecord() {
            if (practiceResults.length === 0) return;

            // 计算统计信息
            const total = practiceResults.length;
            const completed = practiceResults.length;
            let totalCorrect = 0;
            let totalWrong = 0;
            
            practiceResults.forEach(result => {
                totalCorrect += result.correct || 0;
                totalWrong += result.wrong || 0;
            });
            
            const accuracy = total > 0 ? Math.round((totalCorrect / (totalCorrect + totalWrong)) * 100) : 0;

            const record = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                total: total,
                completed: completed,
                correct: totalCorrect,
                wrong: totalWrong,
                accuracy: accuracy,
                results: practiceResults.map(r => ({
                    sentence: r.sentence,
                    userAnswer: r.userAnswer,
                    noteId: r.noteId,
                    correct: r.correct,
                    wrong: r.wrong,
                    missing: r.missing
                }))
            };

            // 从localStorage读取现有记录
            const records = JSON.parse(localStorage.getItem('listeningRecords') || '[]');
            records.unshift(record); // 添加到开头
            
            // 只保留最近50条记录
            if (records.length > 50) {
                records.splice(50);
            }
            
            localStorage.setItem('listeningRecords', JSON.stringify(records));
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>

